---
description: üõ°Ô∏è PROJECT MEMORY - Read before ANY action
globs: **/*
alwaysApply: true
---

# üß† PROJECT MEMORY

> **STOP!** Read this before writing ANY code.
> This is your memory. Without it, you'll break things.

---

## üéØ WHAT IS THIS PROJECT?

**Name:** HVA (Haitham Voice Assistant)
**Purpose:** Arabic voice assistant with GUI dashboard
**Status:** Development

---

## ‚ö° HOW TO RUN

> **Use ONLY these commands. Don't invent new ones.**

```bash
# Frontend (Electron + React):
npm run electron  ‚Üí  opens desktop app

# Backend (FastAPI):
cd api && uvicorn main:app --reload --port 8765
```

---

## ‚ö†Ô∏è RUNNING NOW

| Service | Port | Status |
|---------|------|--------|
| Electron App | - | üü¢ Running |
| FastAPI | 8765 | üü¢ Running |
| WebSocket | 8765 | üü¢ Connected |

> **BEFORE starting any server:** Check this table!
> **NEVER use port 8000 - we use 8765!**

---

## üîß TECH STACK (Detected)

```yaml
Frontend: React 18 + Electron    # from package.json
Backend:  FastAPI + WebSocket    # from requirements.txt
Database: SQLite (memories.db)   # from api/database/
Styling:  Tailwind CSS           # from tailwind.config.js
Voice:    OpenAI Whisper + TTS   # from api/services/
AI:       Claude API             # from api/services/
```

> These are FACTS. Don't suggest Vue, Django, or other alternatives.

---

## üó∫Ô∏è FILE MAP

> **BEFORE creating any file:** Check here first!

```
HVA/
‚îÇ
‚îú‚îÄ‚îÄ üìÇ src/                      # React frontend
‚îÇ   ‚îú‚îÄ‚îÄ components/              # 15 files - UI pieces
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Sidebar.jsx          # Navigation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChatWindow.jsx       # Main chat UI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ VoiceButton.jsx      # Voice recording
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MemoryPanel.jsx      # Memory display
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ToolkitView.jsx      # Debug tools
‚îÇ   ‚îú‚îÄ‚îÄ pages/                   # 4 files - Routes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Home.jsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Settings.jsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Memories.jsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Debug.jsx
‚îÇ   ‚îú‚îÄ‚îÄ hooks/                   # 3 files - Custom hooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useWebSocket.js      # WS connection
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useVoice.js          # Voice recording
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useMemory.js         # Memory operations
‚îÇ   ‚îú‚îÄ‚îÄ lib/                     # Utilities
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api.js               # API client
‚îÇ   ‚îú‚îÄ‚îÄ App.jsx                  # Main component
‚îÇ   ‚îî‚îÄ‚îÄ main.jsx                 # Entry point
‚îÇ
‚îú‚îÄ‚îÄ üìÇ api/                      # FastAPI backend
‚îÇ   ‚îú‚îÄ‚îÄ main.py                  # Entry point + WebSocket
‚îÇ   ‚îú‚îÄ‚îÄ routes/                  # API endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ voice.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ memory.py
‚îÇ   ‚îú‚îÄ‚îÄ services/                # Business logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai_service.py        # Claude integration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ voice_service.py     # Whisper + TTS
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ memory_service.py    # Memory logic
‚îÇ   ‚îî‚îÄ‚îÄ database/
‚îÇ       ‚îú‚îÄ‚îÄ db.py                # SQLite connection
‚îÇ       ‚îî‚îÄ‚îÄ memories.db          # Database file
‚îÇ
‚îú‚îÄ‚îÄ üìÇ electron/                 # Electron main
‚îÇ   ‚îî‚îÄ‚îÄ main.js
‚îÇ
‚îî‚îÄ‚îÄ üìÑ Config files
    ‚îú‚îÄ‚îÄ package.json
    ‚îú‚îÄ‚îÄ vite.config.js
    ‚îú‚îÄ‚îÄ tailwind.config.js
    ‚îî‚îÄ‚îÄ requirements.txt
```

### Key Files (Don't Duplicate!)

| File | Purpose | Warning |
|------|---------|---------|
| `src/hooks/useWebSocket.js` | WS connection | ‚ö†Ô∏è Changes break voice |
| `api/main.py` | Server + WS | ‚ö†Ô∏è Port 8765 hardcoded |
| `src/lib/api.js` | API calls | ‚ö†Ô∏è Base URL here |
| `api/database/db.py` | DB connection | ‚ö†Ô∏è Path to memories.db |

---

## üîó CONNECTIONS MAP

> How parts talk to each other:

```
Electron App
    ‚Üì renders
React Frontend (:5173 dev / electron prod)
    ‚Üì WebSocket
FastAPI (:8765)
    ‚Üì calls
Claude API (external)
    ‚Üì stores
SQLite (memories.db)
```

### API Endpoints

| Endpoint | Method | Used By |
|----------|--------|---------|
| `/ws` | WebSocket | useWebSocket.js |
| `/api/chat` | POST | ChatWindow.jsx |
| `/api/voice/transcribe` | POST | useVoice.js |
| `/api/voice/speak` | POST | ChatWindow.jsx |
| `/api/memories` | GET/POST | MemoryPanel.jsx |

### WebSocket Events

| Event | Direction | Purpose |
|-------|-----------|---------|
| `message` | Both | Chat messages |
| `voice_start` | Client‚ÜíServer | Start recording |
| `voice_end` | Client‚ÜíServer | Stop recording |
| `transcription` | Server‚ÜíClient | Voice text |
| `status` | Server‚ÜíClient | Connection status |

---

## üîÑ CHANGE MANAGEMENT

### Change Classification (Your Responsibility)

When the user asks for ANY change, you MUST:

1. **Classify** the request into one of three types
2. **State** the classification explicitly in your reply
3. **Apply** the rules for that type

> The user does NOT need to know these classifications.
> It's YOUR job to infer and apply the correct rules.

### Classification Types

#### 1Ô∏è‚É£ PURE_UI_STYLE

**What it is:**
- Visual-only changes: colors, spacing, font sizes, alignment, labels, button text, headings
- No new logic, no new state, no component structure changes

**Rules:**
```
‚úÖ Only touch CSS/styling and JSX/HTML text
‚ùå Do NOT create or delete files
‚ùå Do NOT rename components
‚ùå Do NOT change function signatures or add/remove hooks
‚ùå Do NOT change routing, data flow, or API calls
```

#### 2Ô∏è‚É£ UI_BEHAVIOUR_TWEAK

**What it is:**
- Same screen, same components
- Change WHEN or HOW something happens (button enabled/disabled, which message appears, default tab, etc.)

**Rules:**
```
‚úÖ Edit existing components/functions
‚úÖ Reuse existing patterns and utilities
‚ùå Do NOT add new pages/routes
‚ùå Do NOT refactor project structure
‚ùå Limit changes to MINIMUM files needed
```

#### 3Ô∏è‚É£ NEW_FEATURE_FLOW

**What it is:**
- New screen, new route, or new user flow
- New domain concept or major capability

**Rules:**
```
BEFORE coding:
  ‚ñ° Update this memory file with new flow description
  ‚ñ° Confirm design with user in 3-5 bullet points

DURING implementation:
  ‚ñ° Reuse existing architecture and conventions
  ‚ñ° Don't change stable parts without user approval

AFTER implementation:
  ‚ñ° List new files/routes/components added
  ‚ñ° Update FILE MAP and RECENT CHANGES
```

### Quick Examples

| User Request | Classification |
|--------------|----------------|
| "ÿßÿ¨ÿπŸÑ ÿßŸÑÿ≤ÿ± ÿ£ŸÉÿ®ÿ±" | PURE_UI_STYLE |
| "ÿ∫Ÿäÿ± ÿßŸÑŸÜÿµ ŸÑÿπÿ±ÿ®Ÿä" | PURE_UI_STYLE |
| "Change button color to blue" | PURE_UI_STYLE |
| "ÿßŸÑÿ≤ÿ± Ÿäÿ¥ÿ™ÿ∫ŸÑ ÿ®ÿ≥ ŸÑŸÖÿß ŸäŸÉŸàŸÜ ŸÅŸä input" | UI_BEHAVIOUR_TWEAK |
| "ÿ£ÿ∂ŸÅ ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿ¨ÿßÿ≠ ÿ®ÿπÿØ ÿßŸÑÿ≠ŸÅÿ∏" | UI_BEHAVIOUR_TWEAK |
| "Show error toast on failure" | UI_BEHAVIOUR_TWEAK |
| "ÿ£ÿ∂ŸÅ ÿµŸÅÿ≠ÿ© Settings ÿ¨ÿØŸäÿØÿ©" | NEW_FEATURE_FLOW |
| "ÿ£ÿ∂ŸÅ ŸÜÿ∏ÿßŸÖ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™" | NEW_FEATURE_FLOW |
| "Add user authentication" | NEW_FEATURE_FLOW |

### Before You Touch Code (MANDATORY)

For ANY change, you MUST:

```
1. RESTATE the change in 1-2 lines

2. SHOW:
   Classification: [PURE_UI_STYLE / UI_BEHAVIOUR_TWEAK / NEW_FEATURE_FLOW]
   Files to modify: [list paths]
   Will NOT change: [explicit boundaries]

3. WAIT for user to say "ok" before proceeding

4. AFTER changes:
   - Explain what changed (files + behaviour)
   - Add entry to RECENT CHANGES
```

**Example Response:**

```
You want to make the voice button larger.

Classification: PURE_UI_STYLE
Files to modify: src/components/VoiceButton.jsx (styling only)
Will NOT change: voice logic, WebSocket connection, any hooks

Can I proceed?
```

---

## üìù RECENT CHANGES

> **AFTER every change:** Add a row here!

| When | What Changed | Files Affected |
|------|--------------|----------------|
| Dec 3, 14:00 | Fixed WS reconnection | useWebSocket.js |
| Dec 3, 12:00 | Added memory panel | MemoryPanel.jsx, memory.py |
| Dec 2, 18:00 | Voice recording fix | useVoice.js, voice_service.py |

---

## ‚ö†Ô∏è KNOWN ISSUES

> Current bugs or limitations:

```
1. WebSocket disconnects after 5min idle
   ‚Üí Related to: useWebSocket.js
   ‚Üí Don't touch: ping interval setting

2. Memory search slow with 1000+ items
   ‚Üí Related to: memory_service.py
   ‚Üí Needs: pagination
```

---

## üö´ THINGS THAT BREAK EASILY

```
‚ùå Changing port from 8765 ‚Üí Frontend can't connect
‚ùå Changing WS path from /ws ‚Üí Voice breaks
‚ùå Deleting memories.db ‚Üí All data lost
‚ùå Changing api.js baseURL ‚Üí Nothing works
‚ùå Multiple uvicorn instances ‚Üí Port conflict
```

---

## üîç BEFORE ANY ACTION

### Creating a file?
```
‚ñ° Checked FILE MAP - similar file exists?
‚ñ° Know the correct folder?
   - Components ‚Üí src/components/
   - Pages ‚Üí src/pages/
   - Hooks ‚Üí src/hooks/
   - API routes ‚Üí api/routes/
   - Services ‚Üí api/services/
‚ñ° Will update FILE MAP after?
```

### Modifying WebSocket?
```
‚ö†Ô∏è CAREFUL! WebSocket is fragile.
‚ñ° useWebSocket.js handles client connection
‚ñ° main.py handles server side
‚ñ° Port MUST be 8765
‚ñ° Will TEST after change?
```

### Starting a server?
```
‚ñ° Checked RUNNING NOW - already running?
‚ñ° Using exact command from HOW TO RUN?
‚ñ° Will update RUNNING NOW after?
```

### Fixing a bug?
```
‚ñ° Checked KNOWN ISSUES first?
‚ñ° Checked RECENT CHANGES - was it working before?
‚ñ° Will update KNOWN ISSUES after fix?
```

---

## üí¨ WHEN UNSURE

Instead of guessing, say:

> "I see the WebSocket runs on port 8765 and connects at /ws.
> Before I modify the connection logic:
> - Is the server currently running?
> - Should I test with a simple ping first?
> - This might disconnect the current session - proceed?"

---

## ‚úÖ AFTER EVERY RESPONSE

```
‚ñ° Created a file?      ‚Üí Update FILE MAP
‚ñ° Changed structure?   ‚Üí Update FILE MAP
‚ñ° Started a server?    ‚Üí Update RUNNING NOW
‚ñ° Stopped a server?    ‚Üí Update RUNNING NOW
‚ñ° Changed port/path?   ‚Üí Update CONNECTIONS MAP
‚ñ° Fixed a bug?         ‚Üí Update KNOWN ISSUES
‚ñ° Did anything?        ‚Üí Add to RECENT CHANGES
‚ñ° Touched WebSocket?   ‚Üí TEST IMMEDIATELY
```

---

*üõ°Ô∏è Guardian v3 - HVA Project Memory*
*Last synced: 2024-12-03T14:30:00Z*
